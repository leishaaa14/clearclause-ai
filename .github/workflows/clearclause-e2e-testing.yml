name: ClearClause End-to-End Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'ci'
        type: choice
        options:
        - ci
        - staging
        - production
      use_real_services:
        description: 'Use real AWS services'
        required: false
        default: false
        type: boolean
      enable_notifications:
        description: 'Enable result notifications'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '18'
  CI_ENVIRONMENT: ${{ github.event.inputs.environment || 'ci' }}
  CI_USE_REAL_SERVICES: ${{ github.event.inputs.use_real_services || 'false' }}
  CI_NOTIFICATION_ENABLED: ${{ github.event.inputs.enable_notifications || 'true' }}
  CI_ARTIFACT_RETENTION: 30

jobs:
  setup:
    name: Setup and Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      use-real-services: ${{ steps.config.outputs.use-real-services }}
      matrix: ${{ steps.config.outputs.matrix }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure test environment
      id: config
      run: |
        echo "environment=${{ env.CI_ENVIRONMENT }}" >> $GITHUB_OUTPUT
        echo "use-real-services=${{ env.CI_USE_REAL_SERVICES }}" >> $GITHUB_OUTPUT
        
        # Configure test matrix based on environment
        if [ "${{ env.CI_ENVIRONMENT }}" = "production" ]; then
          echo 'matrix={"include":[{"env":"production","parallel":false}]}' >> $GITHUB_OUTPUT
        elif [ "${{ env.CI_ENVIRONMENT }}" = "staging" ]; then
          echo 'matrix={"include":[{"env":"staging","parallel":true}]}' >> $GITHUB_OUTPUT
        else
          echo 'matrix={"include":[{"env":"ci","parallel":false}]}' >> $GITHUB_OUTPUT
        fi

    - name: Validate environment
      run: |
        echo "ðŸ” Validating CI/CD environment configuration..."
        node -e "
          const { TestEnvironmentManager } = require('./test/clearclause-e2e-testing/utils/TestEnvironmentManager.js');
          const manager = new TestEnvironmentManager();
          manager.validateEnvironmentPrerequisites('${{ env.CI_ENVIRONMENT }}')
            .then(() => console.log('âœ… Environment validation passed'))
            .catch(err => { console.error('âŒ Environment validation failed:', err.message); process.exit(1); });
        "

  test-execution:
    name: Execute End-to-End Tests
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure AWS credentials
      if: ${{ needs.setup.outputs.use-real-services == 'true' }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

    - name: Set up test environment variables
      run: |
        echo "VITE_AWS_REGION=${{ secrets.AWS_REGION || 'us-east-1' }}" >> $GITHUB_ENV
        echo "VITE_S3_BUCKET=${{ secrets.S3_BUCKET || 'impactxaws-docs' }}" >> $GITHUB_ENV
        echo "VITE_TEXTRACT_LAMBDA=${{ secrets.TEXTRACT_LAMBDA || 'ClearClause_TextractOCR' }}" >> $GITHUB_ENV
        echo "VITE_URL_LAMBDA=${{ secrets.URL_LAMBDA || 'ClearClause_URLFetcher' }}" >> $GITHUB_ENV
        echo "VITE_BEDROCK_MODEL=${{ secrets.BEDROCK_MODEL || 'anthropic.claude-3-sonnet-20240229-v1:0' }}" >> $GITHUB_ENV
        
        if [ "${{ needs.setup.outputs.use-real-services }}" = "true" ]; then
          echo "VITE_AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "VITE_AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
        fi

    - name: Create test artifacts directory
      run: mkdir -p test-artifacts

    - name: Execute automated tests
      id: test-execution
      run: |
        echo "ðŸš€ Starting ClearClause End-to-End Test Execution..."
        
        # Set execution parameters
        REAL_SERVICES_FLAG=""
        if [ "${{ needs.setup.outputs.use-real-services }}" = "true" ]; then
          REAL_SERVICES_FLAG="--real-services"
        fi
        
        NOTIFY_FLAG=""
        if [ "${{ env.CI_NOTIFICATION_ENABLED }}" = "true" ]; then
          NOTIFY_FLAG="--notify"
        fi
        
        # Execute CI/CD automation
        node test/clearclause-e2e-testing/cicd-automation.js \
          --environment ${{ matrix.env }} \
          $REAL_SERVICES_FLAG \
          $NOTIFY_FLAG \
          --retention ${{ env.CI_ARTIFACT_RETENTION }} \
          --export ./test-exports
        
        echo "test-result=$?" >> $GITHUB_OUTPUT

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-${{ matrix.env }}-${{ github.run_number }}
        path: |
          test-artifacts/
          test-exports/
        retention-days: ${{ env.CI_ARTIFACT_RETENTION }}

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.env }}-${{ github.run_number }}
        path: |
          test-artifacts/*-report.json
          test-artifacts/cicd-*.json
        retention-days: 90

    - name: Generate test summary
      if: always()
      run: |
        echo "## ðŸ§ª ClearClause End-to-End Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
        echo "**Real Services:** ${{ needs.setup.outputs.use-real-services }}" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add test results if available
        if [ -f "test-artifacts/cicd-workflow-report.json" ]; then
          echo "### Workflow Results" >> $GITHUB_STEP_SUMMARY
          node -e "
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('test-artifacts/cicd-workflow-report.json', 'utf8'));
              console.log('**Status:** ' + (report.success ? 'âœ… SUCCESS' : 'âŒ FAILURE'));
              console.log('**Duration:** ' + Math.round(report.duration / 1000) + 's');
              console.log('**Steps Completed:** ' + report.steps.filter(s => s.status === 'completed').length + '/' + report.steps.length);
              if (report.error) {
                console.log('**Error:** ' + report.error.message);
              }
            } catch (e) {
              console.log('**Status:** âš ï¸ Report not available');
            }
          " >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check test results
      if: steps.test-execution.outputs.test-result != '0'
      run: |
        echo "âŒ Tests failed with exit code: ${{ steps.test-execution.outputs.test-result }}"
        exit 1

  notification:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [setup, test-execution]
    if: always() && github.event.inputs.enable_notifications != 'false'
    
    steps:
    - name: Download test artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: test-reports-*
        merge-multiple: true

    - name: Prepare notification data
      id: notification
      run: |
        # Determine overall status
        if [ "${{ needs.test-execution.result }}" = "success" ]; then
          echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
          echo "color=good" >> $GITHUB_OUTPUT
        else
          echo "status=âŒ FAILURE" >> $GITHUB_OUTPUT
          echo "color=danger" >> $GITHUB_OUTPUT
        fi
        
        echo "environment=${{ needs.setup.outputs.environment }}" >> $GITHUB_OUTPUT
        echo "real-services=${{ needs.setup.outputs.use-real-services }}" >> $GITHUB_OUTPUT
        echo "run-url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

    - name: Send Slack notification
      if: env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
          --data '{
            "attachments": [{
              "color": "${{ steps.notification.outputs.color }}",
              "title": "ClearClause End-to-End Test Results",
              "fields": [
                {
                  "title": "Status",
                  "value": "${{ steps.notification.outputs.status }}",
                  "short": true
                },
                {
                  "title": "Environment",
                  "value": "${{ steps.notification.outputs.environment }}",
                  "short": true
                },
                {
                  "title": "Real Services",
                  "value": "${{ steps.notification.outputs.real-services }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref_name }}",
                  "short": true
                }
              ],
              "actions": [{
                "type": "button",
                "text": "View Results",
                "url": "${{ steps.notification.outputs.run-url }}"
              }]
            }]
          }' \
          $SLACK_WEBHOOK_URL

    - name: Create GitHub issue on failure
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Scheduled ClearClause E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `
              ## Test Failure Report
              
              **Environment:** ${{ steps.notification.outputs.environment }}
              **Real Services:** ${{ steps.notification.outputs.real-services }}
              **Run URL:** ${{ steps.notification.outputs.run-url }}
              **Triggered by:** Scheduled execution
              
              The scheduled end-to-end tests have failed. Please investigate and resolve the issues.
              
              ### Next Steps
              1. Review the test execution logs
              2. Check AWS service connectivity
              3. Validate test environment configuration
              4. Fix any identified issues
              5. Re-run the tests manually to verify fixes
              
              This issue was automatically created by the CI/CD pipeline.
            `,
            labels: ['bug', 'ci/cd', 'e2e-tests', 'automated']
          });

  cleanup:
    name: Cleanup and Archival
    runs-on: ubuntu-latest
    needs: [test-execution, notification]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run artifact cleanup
      run: |
        echo "ðŸ—‚ï¸  Running artifact cleanup..."
        node test/clearclause-e2e-testing/cicd-automation.js \
          --cleanup \
          --retention ${{ env.CI_ARTIFACT_RETENTION }}

    - name: Archive workflow data
      run: |
        echo "ðŸ“¦ Archiving workflow execution data..."
        mkdir -p workflow-archive
        
        # Create workflow summary
        cat > workflow-archive/workflow-summary.json << EOF
        {
          "workflow_id": "${{ github.run_id }}",
          "workflow_number": "${{ github.run_number }}",
          "repository": "${{ github.repository }}",
          "branch": "${{ github.ref_name }}",
          "commit": "${{ github.sha }}",
          "environment": "${{ needs.setup.outputs.environment }}",
          "use_real_services": "${{ needs.setup.outputs.use-real-services }}",
          "trigger": "${{ github.event_name }}",
          "status": "${{ needs.test-execution.result }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "duration_minutes": ${{ github.event.created_at && '(($(date +%s) - $(date -d "${{ github.event.created_at }}" +%s)) / 60)' || '0' }}
        }
        EOF

    - name: Upload workflow archive
      uses: actions/upload-artifact@v4
      with:
        name: workflow-archive-${{ github.run_number }}
        path: workflow-archive/
        retention-days: 365